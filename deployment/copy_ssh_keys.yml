- hosts: gateways
  become_method: sudo
  tasks:
  - stat: path=~/.ssh/id_rsa.pub
    when: ssh_public_key is undefined
    register: available_pubkey

  - name: generate ssh pub key if not present
    # pub key may not be present if the ssh key is generated by ansible_user
    when: ssh_public_key is undefined and available_pubkey.stat.exists == False
    shell: ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub

  - name: collect ssh key
    when: ssh_public_key is undefined
    shell: "cat ~/.ssh/id_rsa.pub"
    register: ssh_pub_key

  - name: send ssh key to jump host
    when: ssh_public_key is defined
    delegate_to: "{{ jump_host_alias }}"
    become: true
    authorized_key:
      user: "{{ jump_host_user }}"
      state: present
      key: "{{ ssh_public_key }}"
    notify:
      - restart autossh

  - name: send ssh key to jump host
    when: ssh_public_key is undefined
    delegate_to: "{{ jump_host_alias }}"
    become: true
    authorized_key:
      user: "{{ jump_host_user }}"
      state: present
      key: "{{ ssh_pub_key.stdout }}"
    notify:
      - restart autossh

  handlers:
  - name: restart autossh
    become: true
    service:
      name: autossh-ttn-liv-ctl
      state: restarted
